"use strict";var MARKET_MARKER=2;var MARKET_URL_DIVIDER_TOKEN=[MARKET_MARKER,0,0];if(typeof $==="undefined"){var $=require("min-jquery")}if(typeof encodeValues==="undefined"){var encodeValues=require("./epc-code").encodeValues}if(typeof decodeValues==="undefined"){var decodeValues=require("./epc-code").decodeValues}function factorialSlow(e){var t,r;r=1;for(t=e;t>1;t-=1){r=r*t}return r}var factorialLookup={};function buildFactorialLookup(){var e;for(e=0;e<100;e+=1){factorialLookup[e]=factorialSlow(e)}}buildFactorialLookup();function factorial(e){if(e<100){return factorialLookup[e]}return factorialSlow(e)}function binomial(e,t){if(t>e){return 0}return factorial(e)/factorial(t)/factorial(e-t)}function makeInfluence(e){var t,r,n,i={power:0,fire:0,justice:0,primal:0,shadow:0,time:0,wild:0};for(t=0;t<e.length;t+=1){r=e[t];if(r.charCodeAt(0)>="0".charCodeAt(0)&&r.charCodeAt(0)<="9".charCodeAt(0)){n=Number(r);if(i.power>0){i.power=i.power*10+n}else{i.power=n}}else if(r==="F"){i.fire+=1}else if(r==="J"){i.justice+=1}else if(r==="P"){i.primal+=1}else if(r==="S"){i.shadow+=1}else if(r==="T"){i.time+=1}else if(r==="X"){i.wild+=1}else{i.makeError='Invalid influence: "'+e+'"'}}i.zero=function(){i.power=0;i.fire=0;i.justice=0;i.primal=0;i.time=0;i.shadow=0;i.wild=0};i.isEmpty=function(){if(i.power>0){return false}if(i.fire>0||i.justice>0||i.primal>0||i.time>0||i.shadow>0||i.wild>0){return false}return true};i.toString=function(){var e;if(i.power>0){e=String(i.power)}else{e=""}e=e+"F".repeat(i.fire);e=e+"T".repeat(i.time);e=e+"J".repeat(i.justice);e=e+"P".repeat(i.primal);e=e+"S".repeat(i.shadow);e=e+"X".repeat(i.wild);return e};i.relevantTo=function(e){if(i.power>0&&e.power>0){return true}if(i.fire>0&&e.fire>0){return true}if(i.justice>0&&e.justice>0){return true}if(i.primal>0&&e.primal>0){return true}if(i.shadow>0&&e.shadow>0){return true}if(i.time>0&&e.time>0){return true}if(i.wild>0){if(e.fire>0||e.justice>0||e.primal>0||e.shadow>0||e.time>0){return true}}return false};i.add=function(e,t){i.power+=e*t.power;i.fire+=e*t.fire;i.justice+=e*t.justice;i.primal+=e*t.primal;i.shadow+=e*t.shadow;i.time+=e*t.time;i.wild+=e*t.wild};i.mask=function(e){var t=makeInfluence("");if(e.power>0){t.power=i.power}if(e.fire>0){t.fire=i.fire}if(e.justice>0){t.justice=i.justice}if(e.primal>0){t.primal=i.primal}if(e.shadow>0){t.shadow=i.shadow}if(e.time>0){t.time=i.time}if(e.fire>0||e.justice>0||e.primal>0||e.shadow>0||e.time>0||e.wild>0){t.wild=i.wild}return t};i.equals=function(e){return e.power===i.power&&e.fire===i.fire&&e.justice===i.justice&&e.primal===i.primal&&e.shadow===i.shadow&&e.time===i.time&&e.wild===i.wild};i.compare=function(e){if(i.power!==e.power){return i.power-e.power}if(i.wild!==e.wild){return i.wild-e.wild}if(i.shadow!==e.shadow){return i.shadow-e.shadow}if(i.primal!==e.primal){return i.primal-e.primal}if(i.justice!==e.justice){return i.justice-e.justice}if(i.time!==e.time){return i.time-e.time}if(i.fire!==e.fire){return i.fire-e.fire}return 0};i.satisfies=function(e){var t=0;if(i.power<e.power){return false}if(i.fire<e.fire){t+=e.fire-i.fire}if(i.justice<e.justice){t+=e.justice-i.justice}if(i.primal<e.primal){t+=e.primal-i.primal}if(i.shadow<e.shadow){t+=e.shadow-i.shadow}if(i.time<e.time){t+=e.time-i.time}if(i.wild<t){return false}return true};i.listComponents=function(){var e,t=[];if(i.power>0){e=makeInfluence("");e.power=i.power;t.push(e)}if(i.fire>0){e=makeInfluence("");e.fire=i.fire;t.push(e)}if(i.time>0){e=makeInfluence("");e.time=i.time;t.push(e)}if(i.justice>0){e=makeInfluence("");e.justice=i.justice;t.push(e)}if(i.primal>0){e=makeInfluence("");e.primal=i.primal;t.push(e)}if(i.shadow>0){e=makeInfluence("");e.shadow=i.shadow;t.push(e)}return t};return i}function makeEternalCardInfo(e,t,r,n,i){var o={id:e,name:t,influenceRequirements:[],flags:{}};o.influenceGenerated=makeInfluence(r);if(o.influenceGenerated&&o.influenceGenerated.makeError){o.makeError=o.influenceGenerated.makeError}$.each(n.split(","),function(e,t){var r=makeInfluence(t);if(r){if(r.makeError){o.makeError=r.makeError}else if(!r.isEmpty()){o.influenceRequirements.push(r)}}});$.each(i,function(e,t){o.flags[t]=true});return o}function makeEternalCardLibrary(e){var s={cards:{}};function r(e){var t,r,n,i,o,a,c,u;e=e.trim();if(e.length<=0){return}t=/(Set[0-9]+ #[0-9]+);([^;]*);([^;]*);([^;]*);([^;]*)/;r=e.match(t);if(!r){s.makeError='Invalid card info: "'+e+'"';return}i=r[1];a=r[2].trim();c=r[3].trim();o=r[4].trim();u=r[5].split(",").map(function(e){return e.trim()});n=makeEternalCardInfo(i,o,a,c,u);if(n.makeError){s.makeError=n.makeError+' in "'+e+'"'}s.cards[i]=n}$.each(e.split("\n"),function(e,t){if(s.makeError){return s}r(t)});return s}function makeDrawCombinationIterator(i,o,e,n){var a,c;a={cardGroups:o,cardGroupCount:[],cardGroupInfluence:[],current:[],done:false};c=makeInfluence("");function t(){var e,t;e=a.current.length-1;while(e>=0){t=a.cardGroupCount[e];a.current[e]+=1;if(a.current[e]<=t){return}a.current[e]=0;e-=1}a.done=true}function r(){var e,t,r;c.zero();for(e=0;e<o.length;e+=1){t=a.cardGroupInfluence[e];r=a.current[e];c.add(r,t)}return c.satisfies(n)}function u(){var e,t;t=0;for(e=0;e<o.length;e+=1){t+=a.current[e]}return t}a.next=function(){while(!a.done){t();if(u()<=e&&r()){break}}if(a.done){return{done:true}}return{value:a.current.slice(),done:false}};$.each(o,function(e,t){var r,n;a.current.push(0);n=0;$.each(o[e],function(e,t){r=t.influenceGenerated;n+=i.cardCount[t.id]});a.cardGroupCount.push(n);a.cardGroupInfluence.push(r)});return a}function makeEternalDeck(s,e,t){var l,r,n;function i(e){var n,i;n=[];i={};$.each(e,function(e,t){var r;r=i[t.id];if(r){r.count+=t.count}else{r={id:t.id,name:t.name,count:t.count};n.push(r);i[t.id]=r}});return n}r=i(e);n=i(t);l={cardlibrary:s,cardlist:r,marketlist:n,cards:[],market:[],cardNames:{},marketNames:{},cardCount:{},marketCount:{}};function o(e,t){var r,n,i,o;r=e.id;n=s.cards[r];if(!n){l.makeError='unknown card: "'+r+'"';return}var a=t?"market":"cards";for(o=0;o<e.count;o+=1){l[a].push(n)}var c=t?"marketNames":"cardNames";l[c][r]=e.name;i=e.count;var u=t?"marketCount":"cardCount";if(l[u][r]){i+=l[u][r]}l[u][r]=i}l.listInfluenceRequirements=function(){var o,a,e;e=l.cards.slice().concat(l.market.slice());e.sort(function(e,t){var r,n,i;r=e.influenceRequirements[0];n=t.influenceRequirements[0];if(!r&&!n){return e.id.localeCompare(t.id)}if(!r){return-1}if(!n){return 1}i=r.power-n.power;if(i){return i}return e.id.localeCompare(t.id)});a=[];o={};$.each(e,function(e,i){$.each(i.influenceRequirements,function(e,t){var r,n;r=t.toString();n=o[r];if(n){n[1].push(i);return}n=[t,[i]];a.push(n);o[r]=n})});a.sort(function(e,t){var r,n,i,o,a;r=e[0];n=t[0];i=r.compare(n);if(i){return i}o=e[1][0].id;a=t[1][0].id;$.each(e[1],function(e,t){if(t.id.localeCompare(o)<0){o=t.id}});$.each(t[1],function(e,t){if(t.id.localeCompare(a)<0){a=t.id}});return o.localeCompare(a)});return a};function a(c,e){var n,t;n=[];$.each(Object.getOwnPropertyNames(l.cardCount),function(e,t){var r;r=l.cardlibrary.cards[t];if(r.influenceGenerated&&r.influenceGenerated.relevantTo(c)){n.push(r)}});t=[];$.each(n,function(e,o){var a=false;$.each(t,function(e,t){var r,n,i;if(a){return}r=t[0];n=r.influenceGenerated.mask(c);i=o.influenceGenerated.mask(c);if(n.equals(i)){t.push(o);a=true}});if(!a){t.push([o])}});return makeDrawCombinationIterator(l,t,e,c)}function c(e,t,r){var n,i,o,a,c,u;n=1;o=0;a=0;for(u=0;u<t.length;u+=1){i=t[u];c=e[u];n=n*binomial(c,i);a+=c;o+=i}n=n*binomial(l.cards.length-a,r-o);n=n/binomial(l.cards.length,r);return n}function u(){var r;r=makeInfluence("");$.each(l.cards,function(e,t){if(t.influenceGenerated){r.add(1,t.influenceGenerated)}});return r}l.drawOdds=function(e,t){var r,n,i;if(e>=l.cards.length){if(u().satisfies(t)){return 1}return 0}r=a(t,e);i=0;while(true){n=r.next();if(n.done){break}i=i+c(r.cardGroupCount,n.value,e)}return i};l.listPowerInfluenceSources=function(){var n,i;n=[];i={};$.each(l.cards,function(e,t){var r;if(i[t.id]){return}r=t.influenceGenerated;if(!r.isEmpty()){n.push(t)}i[t.id]=true});return n};l.generateDecklist=function(n){var i;i="";var e=function(e,t){var r;if(!t.count&&n){return}r=String(t.count)+" "+t.name+" ("+t.id+")";i+=r+"\n"};$.each(l.cardlist,e);if(l.marketlist){i+="\n--------------MARKET---------------\n\n";$.each(l.marketlist,e)}return i};l.generateDeckCode=function(){var r,n,i;n=/^Set([0-9]+) #([0-9]+)/;r=[];var e=function(e,t){i=t.id.match(n);if(!i){return null}r.push(t.count);r.push(Number(i[1]));r.push(Number(i[2]))};$.each(l.cardlist,e);if(l.marketlist&&l.marketlist.length){r=r.concat(MARKET_URL_DIVIDER_TOKEN);$.each(l.marketlist,e)}return encodeValues(r)};$.each(r,function(e,t){o(t)});$.each(l.marketlist,function(e,t){o(t,true)});return l}function makeEternalDeckFromString(e,t){var r,a,c,u,s;a=[];u=/^([0-9]+) (.+) \((Set[0-9]+ #[0-9]+)\)$/;s=/^-+MARKET-+$/;var l=[];var d=false;$.each(t.split("\n"),function(e,t){var r,n,i,o;t=t.trim();if(t.length<=0){return}if(t.match(s)){d=true;return}r=t.match(u);if(!r){c='malformed line: "'+t+'"';return}n=Number(r[1]);i=r[2];o=r[3];if(n>100){c='too many cards: "'+t+'"';return}if(d){l.push({id:o,name:i,count:n})}else{a.push({id:o,name:i,count:n})}});r=makeEternalDeck(e,a,l);if(c){r.makeError=c}return r}function makeEternalDeckFromCode(e,t){var r,n,i,o,a,c,u,s,l,d,f,p,m;n=[];i=[];o=decodeValues(t);if(!o){a="malformed deck code"}else{c=0;while(c+2<o.length){u=o[c];s=o[c+1];l=o[c+2];c+=3;if(s===0&&l===0){f=u}else{f=-1}if(f<0){d="Set"+String(s)+" #"+String(l);if(!e.cards[d]){a='unknown card id in deck code: "'+d+'"';break}p=e.cards[d].name;var h={id:d,name:p,count:u};if(m){i.push(h)}else{n.push(h)}}else if(f===MARKET_MARKER){m=true}}if(!a&&c!==o.length){a="malformed deck code "+String(c)}}r=makeEternalDeck(e,n,i);if(a){r.makeError=a}return r}module.exports={makeEternalDeck:makeEternalDeck,makeEternalDeckFromCode:makeEternalDeckFromCode,makeEternalCardLibrary:makeEternalCardLibrary,makeEternalDeckFromString:makeEternalDeckFromString};"use strict";function makeGraphPopupTracker(){var e,a,c,u,t,r,s;e={};r=25;s=12;function l(e){if(a){a.popup("destroy");a.remove();c.remove();u=undefined}}function d(n){var e,i,o,a;function c(e,t){var r,n;r=t.x-e.pos.x;n=t.y-e.pos.y;return r*r+n*n}e=r*r;a=e;$.each(t,function(e,t){var r;r=c(t,n);if(r<a){a=r;o=t}});if(!o){return[]}i=[];$.each(t,function(e,t){var r;r=c(t,o.pos);if(r<s*s){i.push(t)}});i.sort(function(e,t){if(e.pos.y!==t.pos.y){return e.pos.y-t.pos.y}return e.pos.x-t.pos.x});return i}function f(n,e){var i,o;$.each(e,function(e,t){var r;if(e>0){$("<div>").addClass("ui divider").appendTo(n)}i=$("<div>").addClass("power-graph-popup-odds").appendTo(n);addInfluenceDisplay($("<span>").appendTo(i),t.influence,20);o=" - "+String(Math.floor(t.odds*100))+"%";$("<span>").text(o).appendTo(i);r=[];$.each(t.cards,function(e,t){r.push(t.name)});r.sort();$.each(r,function(e,t){$("<div>").addClass("power-graph-popup-cards").text(t).appendTo(n)})})}function o(e,t){var r,n,i,o;i=d(t);if(!i.length){l();return}o=i[0];if(o===u){return}e=$("#power-graph-div");r=$("<div>").addClass("power-graph-popup-anchor").appendTo(e);n=$("<div>").addClass("power-graph-popup ui custom popup hidden").appendTo(e);f(n,i);r.css("position","absolute").css("left",String(o.pos.x)+"px").css("top",String(o.pos.y)+"px");r.popup({on:"",position:"top center"});l();r.popup("show");a=r;c=n;u=o}function n(e){var t,r,n,i;t=$("#power-graph-div");i=t.offset();r=e.clientX+window.pageXOffset-i.left;n=e.clientY+window.pageYOffset-i.top;if(!t.is(":visible")){l()}else if(r<0||r>=t.width()||n<0||n>=t.height()){l()}else{o(t,{x:r,y:n})}}e.setGraphDots=function(e){t=e};$(document).bind("mousemove",n);return e}function drawPowerGraph(e,a,p){var m,t,r,c,i,h,o,u,v,w,k,s,l,d;function f(){var c,u;c={};u=[];$.each(p.cards.slice().concat(p.market.slice()),function(e,o){var t,a;if(o.influenceRequirements.length<1){return}a=o.influenceRequirements[0].power;if(a<1){a=1}t=o.influenceRequirements[0].listComponents();$.each(t,function(e,t){var r,n,i;if(t.power>0){return}r=t.toString();n=r+","+String(a);if(!c.hasOwnProperty(n)){i={influence:t,turn:a,cards:[o]};c[n]=i;u.push(i)}else{i=c[n];if(i.cards.indexOf(o)<0){c[n].cards.push(o)}}})});return u}function n(){var i,n;i={};$.each(f(),function(e,t){var r,n;r=t.influence.toString();n=t.turn;if(i.hasOwnProperty(r)){if(n<i[r]){i[r]=n}}else{i[r]=n}});n=[];$.each(Object.keys(i),function(e,t){var r={influence:makeInfluence(t),turn:i[t]};n.push(r)});return n}function g(e,t){var r,n,i;i=m.measureText(e);r=h.left-i.width-12;n=t+a.fontSize/2;m.fillText(e,r,n)}function b(e,t,r){var n,i,o;o=m.measureText(e);n=t-o.width/2;i=c+r;m.fillText(e,n,i)}function S(){var e,t,r;m.save();m.fillStyle=a.backgroundColor;m.beginPath();m.moveTo(h.left,h.top);m.lineTo(h.left,h.bottom);m.lineTo(h.right,h.bottom);m.lineTo(h.right,h.top);m.lineTo(h.left,h.top);m.fill();m.strokeStyle=a.interiorLineColor;m.lineWidth=.75;e=1-s;while(e>v){t=(e-v)/(1-v);r=h.bottom+t*(h.top-h.bottom);m.beginPath();m.moveTo(h.left,r);m.lineTo(h.right,r);m.stroke();e=e-s}e=w;while(e<=k){t=(e-w)/(k-w);r=h.left+t*(h.right-h.left);m.beginPath();m.moveTo(r,h.top);m.lineTo(r,c-a.fontSize-6);m.stroke();e+=l}m.strokeStyle=a.borderColor;m.beginPath();m.moveTo(h.left,h.top);m.lineTo(h.left,h.bottom);m.lineTo(h.right,h.bottom);m.lineTo(h.right,h.top);m.lineTo(h.left,h.top);m.stroke();m.restore()}function y(){var e,t,r,n;e=1;while(e>v){n=h.bottom+(e-v)/(1-v)*(h.top-h.bottom);t=Math.round(100*e);g(String(t)+"%",n);e=e-s*2}e=w;while(e<=k){r=h.left+(e-w)/(k-w)*(h.right-h.left);b(String(e-6),r,0);e+=l}}function C(e,t,r){var n,i,o;if(e.power>0){n=String(e.power);m.fillText(n,t,r);t+=m.measureText(n).width}o=$("#icon-fire").get(0);for(i=0;i<e.fire;i+=1){m.drawImage(o,t,r-a.iconSize,a.iconSize,a.iconSize);t+=a.iconSize}o=$("#icon-time").get(0);for(i=0;i<e.time;i+=1){m.drawImage(o,t,r-a.iconSize,a.iconSize,a.iconSize);t+=a.iconSize}o=$("#icon-justice").get(0);for(i=0;i<e.justice;i+=1){m.drawImage(o,t,r-a.iconSize,a.iconSize,a.iconSize);t+=a.iconSize}o=$("#icon-primal").get(0);for(i=0;i<e.primal;i+=1){m.drawImage(o,t,r-a.iconSize,a.iconSize,a.iconSize);t+=a.iconSize}o=$("#icon-shadow").get(0);for(i=0;i<e.shadow;i+=1){m.drawImage(o,t,r-a.iconSize,a.iconSize,a.iconSize);t+=a.iconSize}}function T(e){var t,r;t="rgb(0, 0, 0)";r="rgba(0, 0, 0, 0.3)";if(e.fire>0){t=a.fireColorSolid;r=a.fireColorTranslucent}else if(e.time>0){t=a.timeColorSolid;r=a.timeColorTranslucent}else if(e.justice>0){t=a.justiceColorSolid;r=a.justiceColorTranslucent}else if(e.primal>0){t=a.primalColorSolid;r=a.primalColorTranslucent}else if(e.shadow>0){t=a.shadowColorSolid;r=a.shadowColorTranslucent}return{solid:t,translucent:r}}function E(e,t){var r;r=T(e);m.save();m.fillStyle=r.solid;m.strokeStyle="rgb(51, 51, 51)";m.beginPath();m.arc(t.x,t.y,a.dotSize/2,0,2*Math.PI);m.fill();m.stroke();m.restore()}function x(r,n){var i=null;$.each(u,function(e,t){if(!t.influence.equals(r)){return}if(t.turn!==n){return}i=t});return i}function j(e,t){var r,n,i,o,a,c,u,s,l,d,f;m.save();f=T(e);m.strokeStyle=f.solid;m.fillStyle=f.translucent;m.beginPath();m.lineWidth=1.5;o=[];for(i=t;i<=k;i+=1){r=p.drawOdds(i,e);n=(r-v)/(1-v);l=(i-w)/(k-w);a=h.left+l*(h.right-h.left);c=h.bottom+n*(h.top-h.bottom);if(i===t){u=a;s=c;m.moveTo(a,c)}else{m.lineTo(a,c)}d=x(e,i-6);if(d){o.push({influence:e,pos:{x:a,y:c},draws:i-7,odds:r,cards:d.cards})}}m.stroke();m.lineTo(a,h.bottom);m.lineTo(u,h.bottom);m.lineTo(u,s);m.fill();m.restore();return o}function I(e,t){var r,n,i;i=a.iconSize*e.toString().length;r=t.x-i/2;n=t.y+a.iconSize/2;C(e,r,n)}function R(){var i,o,a;a=12;d.sort(function(e,t){var r,n,i,o;r=e.pos;n=t.pos;i=r.x-n.x;o=r.y-n.y;if(i){return i}if(o){return o}});i=0;o=0;$.each(d,function(e,t){var r,n;r=t.pos.x;n=t.pos.y;if(r===i&&n-o<a){n=o+a}I(t.influence,{x:r,y:n});i=r;o=n})}function D(e,t){var r,n,i,o,a,c,u;r=(t-1)/(k-w);n=Math.floor(w+r*(k-w));i=p.drawOdds(n,e);o=(i-v)/(1-v);a=(n-w)/(k-w);c=h.left+a*(h.right-h.left);u=h.bottom+o*(h.top-h.bottom);d.push({influence:e,pos:{x:c,y:u}})}function O(){var n;n=[];$.each(o,function(e,t){var r;r=j(t.influence,w+t.turn-1);n=n.concat(r)});$.each(n,function(e,t){E(t.influence,t.pos)});i=n;$.each(o,function(e,t){D(t.influence,t.turn)})}function P(){var n,e,t;v=.75;w=7;k=15;e=10;t=16;$.each(o,function(e,t){var r=t.turn+w-1;n=p.drawOdds(r,t.influence);if(n<v){v=n}if(r+4>k){k=r+4}});v=(Math.floor(v*10)-3)/10;if(v<0){v=0}l=Math.ceil((k-w)/t);s=.1*Math.ceil((1-v)*10/e)}function z(){r=t.width();c=t.height();t.attr("width",r);t.attr("height",c);d=[];m=t.get(0).getContext("2d");m.clearRect(0,0,r,c);h={left:a.marginLeft,top:a.fontSize/2,right:r-a.marginRight,bottom:c-a.marginBottom};m.fillStyle=a.textColor;m.strokeStyle=a.textColor;m.font=String(a.fontSize)+"px "+a.font;m.lineWidth=1;u=f();o=n();P();S();y();O();R()}function G(){e.empty();t=$("<canvas>").addClass("power-graph-canvas").appendTo(e);$("#icon-fire").bind("load",z);$("#icon-time").bind("load",z);$("#icon-justice").bind("load",z);$("#icon-primal").bind("load",z);$("#icon-shadow").bind("load",z);z()}G();return i}if(!String.prototype.repeat){String.prototype.repeat=function(e){"use strict";if(this==null){throw new TypeError("can't convert "+this+" to object")}var t=""+this;e=+e;if(e!=e){e=0}if(e<0){throw new RangeError("repeat count must be non-negative")}if(e==Infinity){throw new RangeError("repeat count must be less than infinity")}e=Math.floor(e);if(t.length==0||e==0){return""}if(t.length*e>=1<<28){throw new RangeError("repeat count must not overflow maximum string size")}var r="";for(var n=0;n<e;n++){r+=t}return r}}if(!Object.values){Object.values=function e(t){return Object.keys(t).map(function(e){return t[e]})}}"use strict";function makeOddsWorker(a,c,u,n){var i,s,l,d,f,o;s=a.listInfluenceRequirements();l=-1;d=u+1;f=[];o=5;i={deck:a,minDraws:c,maxDraws:u};function p(){var e,t,r,n,i,o;if(d<=u){t=s[l];e=t[0];n=f[f.length-1].odds;o=[];i=e.listComponents();if(i.length>1){$.each(i,function(e,t){r=a.drawOdds(d,t);o.push({component:t,odds:r})})}r=a.drawOdds(d,e);n.push({cumulative:r,components:o});d+=1;return false}if(l+1<s.length){l+=1;t=s[l];e=t[0];f.push({power:e.power,odds:[]});d=c;return false}return true}function m(){var e,t,r;i.timeoutId=undefined;e=performance.now();t=e;r=false;while(!r&&t-e<o){r=p();t=performance.now()}if(p()){n(f)}else{i.timeoutId=setTimeout(m)}}i.cancel=function(){if(i.timeoutId){clearTimeout(i.timeoutId);i.timeoutId=undefined}};i.timeoutId=setTimeout(m);return i}function addInfluenceDisplay(e,t,r){var n;function i(e,t){$("<img>").addClass("power-table-influence-icon").attr("src",t).attr("width",r).attr("height",r).appendTo(e)}if(t.power>0){e.text(String(t.power))}for(n=0;n<t.fire;n+=1){i(e,"icon-fire.png")}for(n=0;n<t.time;n+=1){i(e,"icon-time.png")}for(n=0;n<t.justice;n+=1){i(e,"icon-justice.png")}for(n=0;n<t.primal;n+=1){i(e,"icon-primal.png")}for(n=0;n<t.shadow;n+=1){i(e,"icon-shadow.png")}}function generateOddsTable(n,i,o,a){var c,u,l;c=7;u=27;l=20;function s(u,e){var t,s;s=$("<tr>").addClass("power-table-row-head").appendTo(u);$("<th>").addClass("power-table-head-draws").text("Turns").appendTo(s);t=e.listInfluenceRequirements();$.each(t,function(e,t){var r,n,i,o,a,c;r=t[0];a=t[1].slice();s=$("<tr>").addClass("power-table-row-body").appendTo(u);n=$("<th>").addClass("power-table-influence").appendTo(s);o=$("<div>").appendTo(n);addInfluenceDisplay(o,r,l);i=$("<div>").addClass("ui popup center").appendTo(n);o.popup({position:"top center"});a.sort(function(e,t){return e.name.localeCompare(t.name)});$.each(a,function(e,t){if(t.name===c){return}$("<div>").addClass("table-cost-popup-content").text(t.name).appendTo(i);c=t.name})})}function d(o,e){var a;$.each(e,function(e,t){var r,n,i;i=t.component;n=String(Math.floor(t.odds*100));if(i.power>0){r=" Power"}else{r=""}r+=" - "+n+"%";a=$("<div>").appendTo(o);addInfluenceDisplay($("<span>").appendTo(a),i,l);$("<span>").text(r).appendTo(a)})}function f(r,e){$.each(e,function(e,t){var c,u;u=0;c=$("<tr>").addClass("power-table-row-body").appendTo(r);u=t.power;$.each(t.odds,function(e,t){var r,n,i,o,a;r=Math.floor(t.cumulative*100)+"%";n=$("<td>").addClass("power-table-odds").appendTo(c);i=$("<div>").text(r).appendTo(n);if(t.components.length){n.bind("mouseenter",function(){o=$("<div>").text("Influence Odds").addClass("ui popup center odds-popup").appendTo(n);$("<div>").addClass("ui divider").appendTo(o);a=$("<div>").addClass("odds-popup-content").appendTo(o);d(a,t.components);i.popup({position:"top center"})});n.bind("mouseleave",function(){i.popup("hide");i.popup("destroy");i.remove("popup")})}if(e+1<u){n.addClass("power-table-odds-shaded")}})});n.css("display","inline");i.css("display","inline");$("#power-table-loader").removeClass("active")}function p(t,e){var r,n,i;n=$("<tr>").addClass("power-table-row-head").appendTo(t);for(i=c;i<=u;i+=1){r=String(i-c+1);$("<th>").addClass("power-table-head-draw-count").text(r).appendTo(n)}function o(e){f(t,e)}$("#power-table-loader").addClass("active");return makeOddsWorker(e,c,u,o)}function e(){var e,t,r;if(o.makeError){return}if(a.makeError){return}e=$("<table>").addClass("power-table");s(e,a);t=$("<table>").addClass("power-table");r=p(t,a);n.empty().append(e);i.empty().append(t);n.css("display","none");i.css("display","none");return r}return e()}"use strict";var MAX_MARKET_SIZE=5;function buildEpcUI(n){var e,s,c,d,l,i,o,a;e=$("#card-list").html();s=makeEternalCardLibrary(e);function f(e){var t;if(e.flags.power){return"card-name"}t=e.influenceGenerated;if(!t||t.isEmpty()){return"card-name"}if(t.fire>0&&t.time===0&&t.justice===0&&t.primal===0&&t.shadow===0&&t.wild===0){return"card-name fire"}if(t.time>0&&t.fire===0&&t.justice===0&&t.primal===0&&t.shadow===0&&t.wild===0){return"card-name time"}if(t.justice>0&&t.time===0&&t.fire===0&&t.primal===0&&t.shadow===0&&t.wild===0){return"card-name justice"}if(t.primal>0&&t.time===0&&t.justice===0&&t.fire===0&&t.shadow===0&&t.wild===0){return"card-name primal"}if(t.shadow>0&&t.time===0&&t.justice===0&&t.primal===0&&t.fire===0&&t.wild===0){return"card-name shadow"}return"card-name multi"}function p(e,t,r,n){var i,o,a,c,u,s,l;i=n.name;a=n.count;c=String(a);u=n.id;o=f(r);$("<div>").addClass(o).text(i).appendTo(e);$("<div>").addClass("card-count").text(c).appendTo(e);l=$("<button>").addClass("ui compact button").text("-").appendTo(e);s=$("<button>").addClass("ui compact button").text("+").appendTo(e);s.bind("click",function(){d(t,u,a+1)});l.bind("click",function(){d(t,u,a-1)})}function m(e,t,r,n){var i,o,a,c,u,s;i=n.name;a=n.count;c=String(a);u=n.id;o=f(r);$("<div>").addClass(o).text(i).appendTo(e);$("<div>").addClass("card-count").text(c).appendTo(e);s=$("<button>").addClass("ui compact button").text("-").appendTo(e);s.bind("click",function(){l(t,u,a-1)})}function u(i){var o,a,c,u;o=$("#deck-edit-power-rows");o.empty();a=$("#deck-edit-nonpower-rows");a.empty();u=$("#deck-edit-market-rows");u.empty();$.each(i.cardlist,function(e,t){var r,n;n=t.id;r=s.cards[n];c=$("<div>").addClass("card-count-edit");if(r&&r.flags.power){c.appendTo(o)}else{c.appendTo(a)}p(c,i,r,t)});$.each(i.marketlist,function(e,t){var r,n;n=t.id;r=s.cards[n];c=$("<div>").addClass("card-count-edit");c.appendTo(u);m(c,i,r,t)});if(o.children().length){$("#deck-edit-power-title").css("display","block")}else{$("#deck-edit-power-title").css("display","none")}if(u.children().length){if(i.marketlist.reduce(function(e,t){return e+t.count},0)===MAX_MARKET_SIZE){$("#add-market-card-button").prop("disabled",true)}else{$("#add-market-card-button").prop("disabled",false)}}}function r(e,t){e.text(t);if(t){e.removeClass("zero")}else{e.addClass("zero")}}function h(e){var t,n,i,o,a,c,u,s;t=e.cards.length;n=0;i=0;o=0;a=0;c=0;u=0;s=0;$.each(e.cards,function(e,t){var r;r=t.influenceGenerated;n+=r.power;i+=r.fire;o+=r.time;a+=r.justice;c+=r.primal;u+=r.shadow;s+=r.wild});if(i){i+=s}if(o){o+=s}if(a){a+=s}if(c){c+=s}if(u){u+=s}$("#card-count-number").text(String(t));$("#power-sources-number").text(String(n));r($("#fire-sources-number"),i);r($("#time-sources-number"),o);r($("#justice-sources-number"),a);r($("#primal-sources-number"),c);r($("#shadow-sources-number"),u)}function v(i){$(".power-type-count").each(function(e,t){var r,n;n=0;r=$(t).attr("tag");$.each(i.cards,function(e,t){if(t.flags[r]){n+=1}});$(t).text(String(n))})}function w(e){var t,r;c=e;t=c.generateDecklist(false);try{if(!a){localStorage.setItem("decklist",t)}}catch(e){}if(i){i.cancel()}i=generateOddsTable($("#power-table-cost-div"),$("#power-table-odds-div"),s,e);r=drawPowerGraph($("#power-graph-div"),n,e);o.setGraphDots(r);h(e);v(e);u(e)}d=function(e,r,n){var i,t;i=[];$.each(e.cardlist,function(e,t){if(t.id===r){if(n>=0){i.push({id:t.id,name:t.name,count:n})}}else{i.push(t)}});t=makeEternalDeck(s,i,e.marketlist.slice());w(t)};l=function(e,r,n){var i,t;i=[];if(n>1){return}$.each(e.marketlist,function(e,t){if(t.id===r){if(n>=0){i.push({id:t.id,name:t.name,count:n})}}else{i.push(t)}});t=makeEternalDeck(s,e.cardlist.slice(),i);w(t)};function t(){var e;e=makeEternalDeckFromString(s,$("#import-modal-deck").val());if(e.makeError){$("#import-validation-result").text(e.makeError);$("#import-modal-import-button").addClass("disabled")}else{$("#import-validation-result").text("");$("#import-modal-import-button").removeClass("disabled")}}function k(){var e;e=makeEternalDeckFromString(s,$("#import-modal-deck").val());w(e)}function g(e){var t,r,n;r=document.body.scrollLeft;n=document.body.scrollTop;t=$("<textarea>").appendTo($("body")).val(e).select();document.execCommand("copy");t.remove();document.body.scrollLeft=r;document.body.scrollTop=n}function b(){var e;e=c.generateDecklist(true);g(e)}function S(){var e,t,r;e=c.generateDeckCode();t=String(document.location);r=t.indexOf("?");if(r>=0){t=t.substring(0,r)}t=t+"?d="+e;g(t)}function y(){var e,t;t=c.marketlist.slice();e=makeEternalDeck(s,[],t);w(e)}function C(){var e,t;t=c.cardlist.slice();e=makeEternalDeck(s,t,[]);w(e)}function T(e,t){var r,n,i,o;o=e.val();if(!o.length){return}r=c.cardlist.slice();n=c.marketlist.slice();var a={id:o,name:e.text(),count:1};if(t){n.push(a)}else{r.push(a)}i=makeEternalDeck(s,r,n);w(i)}function E(e,t){$("#error-title").text(e);$("#error-text").text(t);$("#error-modal").modal("show")}function x(){var e,t;if(s.makeError){E("Card list error",s.makeError);return}if(!c.cards.length){t=true;e=$("#import-button");e.popup("show");$(window).bind("click",function(){if(t){e.popup("hide");t=false}})}w(c)}function j(){$(window).bind("load",x);$(".help-icon").popup({position:"top right",offset:6});$("#import-button").popup({on:""});$("#import-button").bind("click",function(){$("#import-modal-deck").val("").select();$("#import-modal").modal("show")});$("#import-modal-deck").bind("input",function(){t()});$("#export-button").popup({on:"click"});$("#export-button").bind("click",function(){b()});$("#link-button").popup({on:"click"});$("#link-button").bind("click",function(){S()});$("#about-heading").bind("click",function(){$("#about-modal").modal("show")});$("#add-card-button").bind("click",function(){$("#add-card-dropdown").dropdown("clear");$("#add-card-modal").modal("show")});$("#add-market-card-button").bind("click",function(){$("#add-market-card-dropdown").dropdown("clear");$("#add-market-card-modal").modal("show")});$("#clear-button").popup({on:"click"});$("#clear-button").bind("click",function(){y();$("#clear-button").popup("reposition")});$("#clear-market-button").popup({on:"click"});$("#clear-market-button").bind("click",function(){C();$("#clear-market-button").popup("reposition")});$("#import-modal-import-button").bind("click",function(){k()});$("#add-card-modal-add-button").bind("click",function(){T($("#add-card-dropdown option:selected"))});$("#add-market-card-modal-add-button").bind("click",function(){T($("#add-market-card-dropdown option:selected"),true)});$("#power-table-container").css("display","none");$("#graph-menu-item").bind("click",function(){$("#power-graph-container").css("display","inline");$("#power-table-container").css("display","none");$("#graph-menu-item").addClass("active");$("#table-menu-item").removeClass("active")});$("#table-menu-item").bind("click",function(){$("#power-graph-container").css("display","none");$("#power-table-container").css("display","inline");$("#graph-menu-item").removeClass("active");$("#table-menu-item").addClass("active")})}function I(){var n,r,i,o;$(".ui.dropdown").dropdown();n=$("#add-card-dropdown");o=$("#add-market-card-dropdown");r=[];i={};$.each(Object.values(s.cards),function(e,t){r.push(t.name);i[t.name]=t.id});r.sort();$.each(r,function(e,t){var r;r=i[t];$("<option>").val(r).text(t).appendTo(n);$("<option>").val(r).text(t).appendTo(o)})}function R(){var e;e=new URLSearchParams(document.location.search);if(!e.has("d")){return false}c=makeEternalDeckFromCode(s,e.get("d"));if(c.makeError){E("Deck code error",c.makeError);c=null;return false}return true}function D(){var e;e="";try{if(localStorage){e=localStorage.getItem("decklist")}}catch(e){}if(!e){e=""}c=makeEternalDeckFromString(s,e);if(c.makeError){c=makeEternalDeckFromString(s,"")}}o=makeGraphPopupTracker();a=R();if(!a){D()}w(c);j();I()}"use strict";if(typeof $==="undefined"){var $=require("min-jquery")}function encodeValues(e){var n,i;n="";$.each(e,function(e,t){var r;if(i){return}if(t<0){i="negative value";return}if(t===0){n=n+"A"}while(t>0){r=t%32;t=(t-r)/32;if(t>0){r=r+32}if(r<26){n=n+String.fromCharCode(65+r)}else if(r<52){n=n+String.fromCharCode(97+r-26)}else if(r<62){n=n+String.fromCharCode(48+r-52)}else if(r===62){n=n+"-"}else if(r===63){n=n+"_"}}});if(i){return null}return n}function decodeValues(e){var t,r,n,i,o,a,c;t=[];n=0;i=1;for(r=0;r<e.length;r+=1){a=e[r];if(a==="-"){o=62}else if(a==="_"){o=63}else{c=a.charCodeAt(0);if(c>=97){o=c-97+26}else if(c>=65){o=c-65}else{o=c-48+52}}if(o>=32){n=n+i*(o%32);i=i*32}else{n=n+i*o;t.push(n);n=0;i=1}}if(i!==1){return null}return t}function testEncode(){function e(e){var t,r,n;t=encodeValues(e);r=decodeValues(t);console.assert(e.length===r.length);for(n=0;n<e.length;n+=1){console.assert(e[n]===r[n])}}e([3,2,1]);e([32,33,64,65,1024,1025]);e([31,63,127,255]);e([30,62,126,254]);console.assert(encodeValues([-1])===null)}module.exports={encodeValues:encodeValues,decodeValues:decodeValues};var URLSearchParams=URLSearchParams||function(){"use strict";function a(e){var t,r,n,i,o,a,c=Object.create(null);this[s]=c;if(!e)return;if(typeof e==="string"){if(e.charAt(0)==="?"){e=e.slice(1)}for(i=e.split("&"),o=0,a=i.length;o<a;o++){n=i[o];t=n.indexOf("=");if(-1<t){d(c,f(n.slice(0,t)),f(n.slice(t+1)))}else if(n.length){d(c,f(n),"")}}}else{if(u(e)){for(o=0,a=e.length;o<a;o++){n=e[o];d(c,n[0],n[1])}}else if(e.forEach){e.forEach(l,c)}else{for(r in e){d(c,r,e[r])}}}}var u=Array.isArray,c=a.prototype,t=/[!'\(\)~]|%20|%00/g,r=/\+/g,n={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"},i=function(e){return n[e]},s="__URLSearchParams__:"+Math.random();function l(e,t){d(this,t,e)}function d(e,t,r){var n=u(r)?r.join(","):r;if(t in e)e[t].push(n);else e[t]=[n]}function f(e){return decodeURIComponent(e.replace(r," "))}function p(e){return encodeURIComponent(e).replace(t,i)}c.append=function e(t,r){d(this[s],t,r)};c["delete"]=function e(t){delete this[s][t]};c.get=function e(t){var r=this[s];return t in r?r[t][0]:null};c.getAll=function e(t){var r=this[s];return t in r?r[t].slice(0):[]};c.has=function e(t){return t in this[s]};c.set=function e(t,r){this[s][t]=[""+r]};c.forEach=function e(r,n){var i=this[s];Object.getOwnPropertyNames(i).forEach(function(t){i[t].forEach(function(e){r.call(n,e,t,this)},this)},this)};c.toJSON=function e(){return{}};c.toString=function e(){var t=this[s],r=[],n,i,o,a;for(i in t){o=p(i);for(n=0,a=t[i];n<a.length;n++){r.push(o+"="+p(a[n]))}}return r.join("&")};var m=Object.defineProperty,h=Object.getOwnPropertyDescriptor,v=function(r){function n(e,t){c.append.call(this,e,t);e=this.toString();r.set.call(this._usp,e?"?"+e:"")}function i(e){c["delete"].call(this,e);e=this.toString();r.set.call(this._usp,e?"?"+e:"")}function o(e,t){c.set.call(this,e,t);e=this.toString();r.set.call(this._usp,e?"?"+e:"")}return function(e,t){e.append=n;e["delete"]=i;e.set=o;return m(e,"_usp",{configurable:true,writable:true,value:t})}},w=function(r){return function(e,t){m(e,"_searchParams",{configurable:true,writable:true,value:r(t,e)});return t}},k=function(e){var t=e.append;e.append=c.append;a.call(e,e._usp.search.slice(1));e.append=t},$=function(e,t){if(!(e instanceof t))throw new TypeError("'searchParams' accessed on an object that "+"does not implement interface "+t.name)},e=function(t){var e=t.prototype,r=h(e,"searchParams"),n=h(e,"href"),i=h(e,"search"),o;if(!r&&i&&i.set){o=w(v(i));Object.defineProperties(e,{href:{get:function(){return n.get.call(this)},set:function(e){var t=this._searchParams;n.set.call(this,e);if(t)k(t)}},search:{get:function(){return i.get.call(this)},set:function(e){var t=this._searchParams;i.set.call(this,e);if(t)k(t)}},searchParams:{get:function(){$(this,t);return this._searchParams||o(this,new a(this.search.slice(1)))},set:function(e){$(this,t);o(this,e)}}})}};e(HTMLAnchorElement);if(/^function|object$/.test(typeof URL)&&URL.prototype)e(URL);return a}();(function(e){var n=function(){try{return!!Symbol.iterator}catch(e){return false}}();if(!("forEach"in e)){e.forEach=function e(r,n){var i=Object.create(null);this.toString().replace(/=[\s\S]*?(?:&|$)/g,"=").split("=").forEach(function(t){if(!t.length||t in i)return;(i[t]=this.getAll(t)).forEach(function(e){r.call(n,e,t,this)},this)},this)}}if(!("keys"in e)){e.keys=function e(){var r=[];this.forEach(function(e,t){r.push(t)});var t={next:function(){var e=r.shift();return{done:e===undefined,value:e}}};if(n){t[Symbol.iterator]=function(){return t}}return t}}if(!("values"in e)){e.values=function e(){var t=[];this.forEach(function(e){t.push(e)});var r={next:function(){var e=t.shift();return{done:e===undefined,value:e}}};if(n){r[Symbol.iterator]=function(){return r}}return r}}if(!("entries"in e)){e.entries=function e(){var r=[];this.forEach(function(e,t){r.push([t,e])});var t={next:function(){var e=r.shift();return{done:e===undefined,value:e}}};if(n){t[Symbol.iterator]=function(){return t}}return t}}if(n&&!(Symbol.iterator in e)){e[Symbol.iterator]=e.entries}if(!("sort"in e)){e.sort=function e(){var t=this.entries(),r=t.next(),n=r.done,i=[],o=Object.create(null),a,c,u;while(!n){u=r.value;c=u[0];i.push(c);if(!(c in o)){o[c]=[]}o[c].push(u[1]);r=t.next();n=r.done}i.sort();for(a=0;a<i.length;a++){this["delete"](i[a])}for(a=0;a<i.length;a++){c=i[a];this.append(c,o[c].shift())}}}})(URLSearchParams.prototype);